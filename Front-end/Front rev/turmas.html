<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Turmas - Sistema de Gest√£o Escolar</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js" defer></script>
</head>
<body>
    <!-- Container que ser√° preenchido pelo JS -->
    <div id="menu-container"></div>

    <main>
        <div class="container">
            <h2>Gest√£o de Turmas</h2>

            <!-- Mensagem de feedback -->
            <div id="feedback-message" class="feedback-message" style="display: none;"></div>

            <!-- Barra de op√ß√µes de CRUD -->
            <div class="crud-bar">
                <!-- Campo de busca -->
                <input type="search" 
                       id="buscar-turma" 
                       placeholder="Buscar por nome, professor ou curso..." 
                       aria-label="Buscar turmas">

                <!-- Bot√µes de a√ß√£o -->
                <button type="button" 
                        id="btn-incluir" 
                        class="btn-success" 
                        onclick="incluirTurma()">
                    Nova Turma
                </button>
                <button type="button" 
                        id="btn-alterar" 
                        onclick="alterarTurma()" 
                        disabled>
                    Editar
                </button>
                <button type="button" 
                        id="btn-excluir" 
                        class="btn-danger" 
                        onclick="excluirTurma()" 
                        disabled>
                    Excluir
                </button>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-number" id="total-turmas-count">0</span>
                    <span class="stat-label">Total de Turmas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="turmas-ativas-count">0</span>
                    <span class="stat-label">Turmas Ativas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="turmas-filtradas-count">0</span>
                    <span class="stat-label">Resultados da Busca</span>
                </div>
            </div>

            <!-- Tabela de turmas -->
            <div class="table-container">
                <table class="table" id="tabela-turmas">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" 
                                       id="select-all" 
                                       aria-label="Selecionar todas as turmas">
                            </th>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Professor</th>
                            <th>Curso</th>
                            <th>Ano</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-turmas">
                        <!-- BACKEND: Dados ser√£o carregados via JavaScript a partir de uma API -->
                    </tbody>
                </table>
                
                <!-- Mensagem quando n√£o h√° dados -->
                <div id="no-data-message" class="no-data-message" style="display: none;">
                    <p>Nenhuma turma encontrada.</p>
                    <button type="button" onclick="incluirTurma()" class="btn-success">
                        Cadastrar Primeira Turma
                    </button>
                </div>
            </div>

            <!-- Pagina√ß√£o -->
            <div class="pagination" id="pagination-container" style="display: none;">
                <button type="button" id="btn-prev" onclick="previousPage()" disabled>
                    Anterior
                </button>
                <span id="page-info">P√°gina 1 de 1</span>
                <button type="button" id="btn-next" onclick="nextPage()" disabled>
                    Pr√≥xima
                </button>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script src="menu.js"></script>
    <script>
        // ================================
        // DADOS MOCK DAS TURMAS (BACKEND: Substituir por chamada √† API)
        // ================================
        let turmas = [
            { 
                id: "T001", 
                nome: "Turma A - 1¬∫ Ano", 
                professor: "Carlos Silva", 
                curso: "Ensino Fundamental",
                ano: "2025",
                status: "Ativa",
                dataCriacao: "2024-01-01"
            },
            { 
                id: "T002", 
                nome: "Turma B - 2¬∫ Ano", 
                professor: "Ana Souza", 
                curso: "Ensino Fundamental",
                ano: "2025",
                status: "Ativa",
                dataCriacao: "2024-01-05"
            },
            { 
                id: "T003", 
                nome: "Turma C - 3¬∫ Ano", 
                professor: "Jo√£o Pereira", 
                curso: "Ensino M√©dio",
                ano: "2025",
                status: "Ativa",
                dataCriacao: "2024-01-10"
            },
            { 
                id: "T004", 
                nome: "Turma D - 1¬∫ Ano", 
                professor: "Maria Oliveira", 
                curso: "Ensino M√©dio",
                ano: "2025",
                status: "Inativa",
                dataCriacao: "2024-01-15"
            }
        ];

        // Vari√°veis de controle
        let turmasFiltradas = [...turmas];
        let currentPage = 1;
        const itemsPerPage = CONFIG.ITEMS_PER_PAGE; // BACKEND: CONFIG.ITEMS_PER_PAGE pode ser um valor padr√£o ou vir do backend
        let selectedTurmas = new Set();

        // ================================
        // INICIALIZA√á√ÉO
        // ================================
        document.addEventListener("DOMContentLoaded", function() {
            // BACKEND: Verificar autentica√ß√£o
            if (!Auth.requireAuth()) return; // Auth.requireAuth() deve ser adaptado para o sistema de autentica√ß√£o do backend

            // Configurar eventos
            setupEventListeners();
            
            // Carregar dados
            // BACKEND: loadTurmas() deve chamar a API para buscar as turmas
            loadTurmas();
            
            // Atualizar estat√≠sticas
            // BACKEND: updateStats() pode precisar de dados do backend
            updateStats();
        });

        // ================================
        // CONFIGURAR EVENT LISTENERS
        // ================================
        function setupEventListeners() {
            // Busca em tempo real
            const searchInput = document.getElementById("buscar-turma");
            searchInput.addEventListener("input", debounce(filtrarTurmas, 300));

            // Selecionar todos
            const selectAllCheckbox = document.getElementById("select-all");
            selectAllCheckbox.addEventListener("change", toggleSelectAll);

            // Teclas de atalho
            document.addEventListener("keydown", handleKeyboardShortcuts);
        }

        // ================================
        // CARREGAR TURMAS NA TABELA
        // ================================
        async function loadTurmas() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const tbody = document.getElementById("tbody-turmas");
            const noDataMessage = document.getElementById("no-data-message");
            
            // Limpar tabela
            Table.clearBody("tabela-turmas");

            // BACKEND: Chamar API para buscar turmas
            // try {
            //   const response = await fetch(`/api/turmas?page=${currentPage}&limit=${itemsPerPage}&search=${document.getElementById("buscar-turma").value}`);
            //   if (!response.ok) throw new Error("Erro ao carregar turmas");
            //   const data = await response.json(); // data.turmas, data.totalTurmas, etc.
            //   turmas = data.turmas; // Atualizar a lista de turmas com os dados do backend
            //   turmasFiltradas = data.turmas; // Se a API j√° retorna filtrado/paginado
            // } catch (error) {
            //   console.error("Erro ao buscar turmas:", error);
            //   UI.showMessage("N√£o foi poss√≠vel carregar as turmas.", "error");
            //   return;
            // }
            
            if (turmasFiltradas.length === 0) {
                document.querySelector(".table-container table").style.display = "none";
                noDataMessage.style.display = "block";
                document.getElementById("pagination-container").style.display = "none";
                return;
            }

            document.querySelector(".table-container table").style.display = "table";
            noDataMessage.style.display = "none";

            // Calcular pagina√ß√£o (se a API n√£o fizer isso, ou para dados mock)
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const turmasPage = turmasFiltradas.slice(startIndex, endIndex);

            // Criar linhas
            turmasPage.forEach(turma => {
                const row = createTurmaRow(turma);
                Table.addRow("tabela-turmas", row);
            });

            // Atualizar pagina√ß√£o
            updatePagination();
            
            // Atualizar bot√µes
            updateActionButtons();
        }

        // ================================
        // CRIAR LINHA DA TABELA
        // ================================
        function createTurmaRow(turma) {
            const row = document.createElement("tr");
            row.dataset.turmaId = turma.id;
            
            const isSelected = selectedTurmas.has(turma.id);
            const statusClass = turma.status === "Ativa" ? "status-active" : "status-inactive";
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" 
                           class="turma-checkbox" 
                           value="${turma.id}" 
                           ${isSelected ? "checked" : ""}
                           onchange="toggleTurmaSelection(\'${turma.id}\')">
                </td>
                <td>${turma.id}</td>
                <td>${turma.nome}</td>
                <td>${turma.professor}</td>
                <td>${turma.curso}</td>
                <td>${turma.ano}</td>
                <td><span class="status-badge ${statusClass}">${turma.status}</span></td>
                <td class="actions">
                    <button type="button" 
                            class="btn-sm" 
                            onclick="administrarTurma(\'${turma.id}\')" 
                            title="Administrar turma">
                        ‚öôÔ∏è
                    </button>
                    <button type="button" 
                            class="btn-sm" 
                            onclick="editarTurma(\'${turma.id}\')" 
                            title="Editar turma">
                        ‚úèÔ∏è
                    </button>
                    <button type="button" 
                            class="btn-sm btn-danger" 
                            onclick="confirmarExclusao(\'${turma.id}\')" 
                            title="Excluir turma">
                        üóëÔ∏è
                    </button>
                </td>
            `;
            
            return row;
        }

        // ================================
        // FILTRAR TURMAS
        // ================================
        async function filtrarTurmas() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const searchTerm = document.getElementById("buscar-turma").value.toLowerCase();
            
            // BACKEND: Se a filtragem for feita no backend, chamar a API com o searchTerm
            // try {
            //   const response = await fetch(`/api/turmas?search=${searchTerm}`);
            //   if (!response.ok) throw new Error("Erro ao filtrar turmas");
            //   turmasFiltradas = await response.json();
            // } catch (error) {
            //   console.error("Erro ao filtrar turmas:", error);
            //   UI.showMessage("N√£o foi poss√≠vel filtrar as turmas.", "error");
            //   return;
            // }

            if (!searchTerm) {
                turmasFiltradas = [...turmas]; // Usar a lista original se n√£o houver termo de busca
            } else {
                turmasFiltradas = turmas.filter(turma => 
                    turma.nome.toLowerCase().includes(searchTerm) ||
                    turma.professor.toLowerCase().includes(searchTerm) ||
                    turma.curso.toLowerCase().includes(searchTerm) ||
                    turma.ano.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            selectedTurmas.clear();
            loadTurmas();
            updateStats();
        }

        // ================================
        // SELE√á√ÉO DE TURMAS
        // ================================
        function toggleTurmaSelection(turmaId) {
            if (selectedTurmas.has(turmaId)) {
                selectedTurmas.delete(turmaId);
            } else {
                selectedTurmas.add(turmaId);
            }
            
            updateActionButtons();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".turma-checkbox");
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedTurmas.add(checkbox.value);
                });
            } else {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedTurmas.delete(checkbox.value);
                });
            }
            
            updateActionButtons();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".turma-checkbox");
            const checkedBoxes = document.querySelectorAll(".turma-checkbox:checked");
            
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // ================================
        // ATUALIZAR BOT√ïES DE A√á√ÉO
        // ================================
        function updateActionButtons() {
            const hasSelection = selectedTurmas.size > 0;
            const singleSelection = selectedTurmas.size === 1;
            
            document.getElementById("btn-alterar").disabled = !singleSelection;
            document.getElementById("btn-excluir").disabled = !hasSelection;
        }

        // ================================
        // FUN√á√ïES DE CRUD
        // ================================
        function incluirTurma() {
            window.location.href = "nova-turma.html"; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        function alterarTurma() {
            if (selectedTurmas.size !== 1) {
                UI.showMessage("Selecione exatamente uma turma para editar.", "warning");
                return;
            }
            
            const turmaId = Array.from(selectedTurmas)[0];
            window.location.href = `alterar-turma.html?id=${turmaId}`; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        function editarTurma(turmaId) {
            window.location.href = `alterar-turma.html?id=${turmaId}`; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        async function excluirTurma() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            if (selectedTurmas.size === 0) {
                UI.showMessage("Selecione pelo menos uma turma para excluir.", "warning");
                return;
            }
            
            const count = selectedTurmas.size;
            const message = count === 1 
                ? "Tem certeza que deseja excluir esta turma?" 
                : `Tem certeza que deseja excluir ${count} turmas?`;
            
            if (confirm(message)) {
                // BACKEND: Chamar API para exclus√£o de turmas
                // try {
                //   const response = await fetch("/api/turmas/batch-delete", {
                //     method: "DELETE",
                //     headers: { "Content-Type": "application/json" },
                //     body: JSON.stringify({ ids: Array.from(selectedTurmas) })
                //   });
                //   if (!response.ok) throw new Error("Erro ao excluir turmas");
                //   // L√≥gica para remover do array local se necess√°rio, ou recarregar
                // } catch (error) {
                //   console.error("Erro ao excluir turmas:", error);
                //   UI.showMessage("N√£o foi poss√≠vel excluir as turmas.", "error");
                //   return;
                // }

                // Simular exclus√£o (integrar com backend)
                selectedTurmas.forEach(turmaId => {
                    const index = turmas.findIndex(t => t.id === turmaId);
                    if (index > -1) {
                        turmas.splice(index, 1);
                    }
                });
                
                selectedTurmas.clear();
                filtrarTurmas(); // Recarregar dados ap√≥s exclus√£o
                UI.showMessage(`${count} turma(s) exclu√≠da(s) com sucesso.`, "success");
            }
        }

        async function confirmarExclusao(turmaId) { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) return;
            
            if (confirm(`Tem certeza que deseja excluir a turma \"${turma.nome}\"?`)) {
                // BACKEND: Chamar API para exclus√£o de um √∫nica turma
                // try {
                //   const response = await fetch(`/api/turmas/${turmaId}`, {
                //     method: "DELETE"
                //   });
                //   if (!response.ok) throw new Error("Erro ao excluir turma");
                // } catch (error) {
                //   console.error("Erro ao excluir turma:", error);
                //   UI.showMessage("N√£o foi poss√≠vel excluir a turma.", "error");
                //   return;
                // }

                const index = turmas.findIndex(t => t.id === turmaId);
                if (index > -1) {
                    turmas.splice(index, 1);
                    filtrarTurmas(); // Recarregar dados ap√≥s exclus√£o
                    UI.showMessage("Turma exclu√≠da com sucesso.", "success");
                }
            }
        }

        function administrarTurma(turmaId) {
            window.location.href = `administrar-turma.html?id=${turmaId}`; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        // ================================
        // PAGINA√á√ÉO
        // ================================
        function updatePagination() {
            const totalPages = Math.ceil(turmasFiltradas.length / itemsPerPage);
            const paginationContainer = document.getElementById("pagination-container");
            
            if (totalPages <= 1) {
                paginationContainer.style.display = "none";
                return;
            }
            
            paginationContainer.style.display = "flex";
            
            document.getElementById("btn-prev").disabled = currentPage === 1;
            document.getElementById("btn-next").disabled = currentPage === totalPages;
            document.getElementById("page-info").textContent = `P√°gina ${currentPage} de ${totalPages}`;
        }

        function nextPage() {
            const totalPages = Math.ceil(turmasFiltradas.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                loadTurmas();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTurmas();
            }
        }

        // ================================
        // ATUALIZAR ESTAT√çSTICAS
        // ================================
        function updateStats() {
            document.getElementById("total-turmas-count").textContent = turmas.length; // BACKEND: Total de turmas do backend
            document.getElementById("turmas-ativas-count").textContent = turmas.filter(t => t.status === "Ativa").length; // BACKEND: Contagem de ativas do backend
            document.getElementById("turmas-filtradas-count").textContent = turmasFiltradas.length;
        }

        // ================================
        // UTILS (do common.js, se n√£o estiver globalmente dispon√≠vel)
        // ================================
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
    </script>
</body>
</html>

