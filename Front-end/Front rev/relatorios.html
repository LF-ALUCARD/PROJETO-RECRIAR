<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rios - Instituto Recriar</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js" defer></script>
</head>
<body>
  <!-- Menu lateral ser√° preenchido pelo JS -->
  <div id="menu-container"></div>

  <main>
    <div class="container">
      <h2>Relat√≥rios do Sistema</h2>
      
      <div id="feedback-message" class="feedback-message" style="display:none;"></div>
      
      <!-- Filtros gerais para relat√≥rios -->
      <div class="filtros-relatorio">
        <h3>Filtros</h3>
        <div class="filtros-grid">
          <div class="form-group">
            <label for="periodo-inicio">Data In√≠cio</label>
            <input type="date" id="periodo-inicio" name="periodo-inicio">
          </div>
          <div class="form-group">
            <label for="periodo-fim">Data Fim</label>
            <input type="date" id="periodo-fim" name="periodo-fim">
          </div>
          <div class="form-group">
            <label for="turma-filtro">Turma</label>
            <select id="turma-filtro" name="turma-filtro">
              <option value="">Todas as turmas</option>
              <!-- BACKEND: Carregar turmas dinamicamente -->
            </select>
          </div>
          <div class="form-group">
            <label for="professor-filtro">Professor</label>
            <select id="professor-filtro" name="professor-filtro">
              <option value="">Todos os professores</option>
              <!-- BACKEND: Carregar professores dinamicamente -->
            </select>
          </div>
        </div>
        <div class="filtros-acoes">
          <button type="button" id="limpar-filtros" class="btn-secundario">Limpar Filtros</button>
          <button type="button" id="aplicar-filtros">Aplicar Filtros</button>
        </div>
      </div>

      <!-- Grid de relat√≥rios dispon√≠veis -->
      <div class="relatorios-grid">
        
        <!-- Relat√≥rio de Alunos -->
        <div class="relatorio-card">
          <h3>üìä Relat√≥rio de Alunos</h3>
          <p>Lista completa de alunos matriculados com informa√ß√µes pessoais, respons√°veis e dados de contato.</p>
          <button class="btn-relatorio" data-relatorio="alunos">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Professores -->
        <div class="relatorio-card">
          <h3>üë®‚Äçüè´ Relat√≥rio de Professores</h3>
          <p>Informa√ß√µes dos professores cadastrados, suas especialidades e turmas atribu√≠das.</p>
          <button class="btn-relatorio" data-relatorio="professores">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Turmas -->
        <div class="relatorio-card">
          <h3>üìö Relat√≥rio de Turmas</h3>
          <p>Detalhes das turmas ativas, quantidade de alunos por turma e professores respons√°veis.</p>
          <button class="btn-relatorio" data-relatorio="turmas">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Frequ√™ncia -->
        <div class="relatorio-card">
          <h3>üìÖ Relat√≥rio de Frequ√™ncia</h3>
          <p>Controle de presen√ßa dos alunos por per√≠odo, turma ou disciplina espec√≠fica.</p>
          <button class="btn-relatorio" data-relatorio="frequencia">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Matr√≠culas -->
        <div class="relatorio-card">
          <h3>üìù Relat√≥rio de Matr√≠culas</h3>
          <p>Hist√≥rico de matr√≠culas realizadas por per√≠odo, incluindo novas matr√≠culas e transfer√™ncias.</p>
          <button class="btn-relatorio" data-relatorio="matriculas">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio Estat√≠stico -->
        <div class="relatorio-card">
          <h3>üìà Relat√≥rio Estat√≠stico</h3>
          <p>Estat√≠sticas gerais do sistema: total de alunos, professores, turmas e indicadores de desempenho.</p>
          <button class="btn-relatorio" data-relatorio="estatisticas">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Contatos -->
        <div class="relatorio-card">
          <h3>üìû Relat√≥rio de Contatos</h3>
          <p>Lista de contatos de respons√°veis e alunos para comunica√ß√£o e emerg√™ncias.</p>
          <button class="btn-relatorio" data-relatorio="contatos">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio de Aniversariantes -->
        <div class="relatorio-card">
          <h3>üéÇ Aniversariantes do M√™s</h3>
          <p>Lista de alunos e funcion√°rios que fazem anivers√°rio no m√™s selecionado.</p>
          <button class="btn-relatorio" data-relatorio="aniversariantes">Gerar Relat√≥rio</button>
        </div>

        <!-- Relat√≥rio Personalizado -->
        <div class="relatorio-card">
          <h3>‚öôÔ∏è Relat√≥rio Personalizado</h3>
          <p>Configure campos espec√≠ficos e filtros avan√ßados para criar relat√≥rios customizados.</p>
          <button class="btn-relatorio" data-relatorio="personalizado">Configurar</button>
        </div>

      </div>

      <!-- √Årea de preview do relat√≥rio -->
      <div id="relatorio-preview" style="display: none;">
        <h3>Preview do Relat√≥rio</h3>
        <div id="relatorio-conteudo"></div>
        <div class="form-actions">
          <button type="button" id="exportar-pdf">üìÑ Exportar PDF</button>
          <button type="button" id="exportar-excel">üìä Exportar Excel</button>
          <button type="button" id="imprimir-relatorio">üñ®Ô∏è Imprimir</button>
          <button type="button" id="fechar-preview" class="btn-secundario">Fechar</button>
        </div>
      </div>

    </div>
  </main>

  <script src="menu.js" defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // BACKEND: Carregar dados iniciais para os filtros
      carregarFiltrosIniciais();
      
      // Configurar eventos dos bot√µes de relat√≥rio
      configurarEventosRelatorios();
      
      // Configurar filtros
      configurarFiltros();
    });

    /**
     * Carrega dados iniciais para os filtros (turmas e professores)
     * BACKEND: Substituir por chamadas reais √† API
     */
    async function carregarFiltrosIniciais() {
      try {
        // BACKEND: Carregar turmas
        // const turmasResponse = await fetch('/api/turmas');
        // const turmas = await turmasResponse.json();
        
        // Simula√ß√£o de dados de turmas
        const turmas = [
          { id: 1, nome: 'Turma A - Manh√£' },
          { id: 2, nome: 'Turma B - Tarde' },
          { id: 3, nome: 'Turma C - Noite' }
        ];
        
        const turmaSelect = document.getElementById('turma-filtro');
        turmas.forEach(turma => {
          const option = document.createElement('option');
          option.value = turma.id;
          option.textContent = turma.nome;
          turmaSelect.appendChild(option);
        });

        // BACKEND: Carregar professores
        // const professoresResponse = await fetch('/api/professores');
        // const professores = await professoresResponse.json();
        
        // Simula√ß√£o de dados de professores
        const professores = [
          { id: 1, nome: 'Prof. Jo√£o Silva' },
          { id: 2, nome: 'Prof. Maria Santos' },
          { id: 3, nome: 'Prof. Carlos Oliveira' }
        ];
        
        const professorSelect = document.getElementById('professor-filtro');
        professores.forEach(professor => {
          const option = document.createElement('option');
          option.value = professor.id;
          option.textContent = professor.nome;
          professorSelect.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar filtros:', error);
        UI.showMessage('Erro ao carregar filtros. Alguns filtros podem n√£o estar dispon√≠veis.', 'warning');
      }
    }

    /**
     * Configura eventos dos bot√µes de relat√≥rio
     */
    function configurarEventosRelatorios() {
      const botoesRelatorio = document.querySelectorAll('.btn-relatorio');
      
      botoesRelatorio.forEach(botao => {
        botao.addEventListener('click', function() {
          const tipoRelatorio = this.getAttribute('data-relatorio');
          gerarRelatorio(tipoRelatorio);
        });
      });

      // Eventos dos bot√µes de a√ß√£o do preview
      document.getElementById('exportar-pdf')?.addEventListener('click', () => exportarRelatorio('pdf'));
      document.getElementById('exportar-excel')?.addEventListener('click', () => exportarRelatorio('excel'));
      document.getElementById('imprimir-relatorio')?.addEventListener('click', imprimirRelatorio);
      document.getElementById('fechar-preview')?.addEventListener('click', fecharPreview);
    }

    /**
     * Configura eventos dos filtros
     */
    function configurarFiltros() {
      document.getElementById('limpar-filtros')?.addEventListener('click', limparFiltros);
      document.getElementById('aplicar-filtros')?.addEventListener('click', aplicarFiltros);
    }

    /**
     * Gera um relat√≥rio baseado no tipo especificado
     * @param {string} tipo - Tipo do relat√≥rio a ser gerado
     */
    async function gerarRelatorio(tipo) {
      try {
        UI.showMessage('Gerando relat√≥rio...', 'info');
        
        // Coletar filtros aplicados
        const filtros = coletarFiltros();
        
        // BACKEND: Substituir por chamada real √† API
        // const response = await fetch(`/api/relatorios/${tipo}`, {
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json',
        //     'Authorization': `Bearer ${sessionStorage.getItem('auth_token')}`
        //   },
        //   body: JSON.stringify(filtros)
        // });

        // if (!response.ok) {
        //   throw new Error('Erro ao gerar relat√≥rio');
        // }

        // const dadosRelatorio = await response.json();

        // Simula√ß√£o de dados do relat√≥rio
        const dadosRelatorio = gerarDadosSimulados(tipo, filtros);
        
        // Exibir preview do relat√≥rio
        exibirPreviewRelatorio(tipo, dadosRelatorio);
        
        UI.showMessage('Relat√≥rio gerado com sucesso!', 'success');
        
      } catch (error) {
        console.error('Erro ao gerar relat√≥rio:', error);
        UI.showMessage(error.message || 'Erro ao gerar relat√≥rio. Tente novamente.', 'error');
      }
    }

    /**
     * Coleta os filtros aplicados pelo usu√°rio
     * @returns {Object} Objeto com os filtros aplicados
     */
    function coletarFiltros() {
      return {
        dataInicio: document.getElementById('periodo-inicio')?.value || null,
        dataFim: document.getElementById('periodo-fim')?.value || null,
        turmaId: document.getElementById('turma-filtro')?.value || null,
        professorId: document.getElementById('professor-filtro')?.value || null
      };
    }

    /**
     * Gera dados simulados para o relat√≥rio
     * BACKEND: Esta fun√ß√£o ser√° removida quando integrada com a API real
     */
    function gerarDadosSimulados(tipo, filtros) {
      const dados = {
        tipo: tipo,
        filtros: filtros,
        dataGeracao: new Date().toLocaleString('pt-BR'),
        dados: []
      };

      switch (tipo) {
        case 'alunos':
          dados.titulo = 'Relat√≥rio de Alunos';
          dados.dados = [
            { nome: 'Jo√£o Silva', turma: 'Turma A', responsavel: 'Maria Silva', telefone: '(11) 99999-9999' },
            { nome: 'Ana Santos', turma: 'Turma B', responsavel: 'Jos√© Santos', telefone: '(11) 88888-8888' }
          ];
          break;
        case 'professores':
          dados.titulo = 'Relat√≥rio de Professores';
          dados.dados = [
            { nome: 'Prof. Jo√£o Silva', especialidade: 'Matem√°tica', turmas: 'A, B' },
            { nome: 'Prof. Maria Santos', especialidade: 'Portugu√™s', turmas: 'C, D' }
          ];
          break;
        case 'turmas':
          dados.titulo = 'Relat√≥rio de Turmas';
          dados.dados = [
            { nome: 'Turma A - Manh√£', alunos: 25, professor: 'Prof. Jo√£o Silva' },
            { nome: 'Turma B - Tarde', alunos: 30, professor: 'Prof. Maria Santos' }
          ];
          break;
        default:
          dados.titulo = `Relat√≥rio de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
          dados.dados = [{ info: 'Dados simulados para ' + tipo }];
      }

      return dados;
    }

    /**
     * Exibe o preview do relat√≥rio gerado
     */
    function exibirPreviewRelatorio(tipo, dados) {
      const preview = document.getElementById('relatorio-preview');
      const conteudo = document.getElementById('relatorio-conteudo');
      
      let html = `
        <div class="relatorio-header">
          <h4>${dados.titulo}</h4>
          <p><strong>Data de Gera√ß√£o:</strong> ${dados.dataGeracao}</p>
        </div>
        <div class="relatorio-body">
      `;

      if (dados.dados.length > 0) {
        html += '<table class="table">';
        
        // Cabe√ßalho da tabela
        const primeiroItem = dados.dados[0];
        html += '<thead><tr>';
        Object.keys(primeiroItem).forEach(key => {
          html += `<th>${key.charAt(0).toUpperCase() + key.slice(1)}</th>`;
        });
        html += '</tr></thead>';
        
        // Dados da tabela
        html += '<tbody>';
        dados.dados.forEach(item => {
          html += '<tr>';
          Object.values(item).forEach(value => {
            html += `<td>${value}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<p>Nenhum dado encontrado para os filtros aplicados.</p>';
      }

      html += '</div>';
      
      conteudo.innerHTML = html;
      preview.style.display = 'block';
      preview.scrollIntoView({ behavior: 'smooth' });
    }

    /**
     * Exporta o relat√≥rio no formato especificado
     */
    function exportarRelatorio(formato) {
      // BACKEND: Implementar exporta√ß√£o real
      UI.showMessage(`Exportando relat√≥rio em formato ${formato.toUpperCase()}...`, 'info');
      
      // Simula√ß√£o de download
      setTimeout(() => {
        UI.showMessage(`Relat√≥rio exportado com sucesso em ${formato.toUpperCase()}!`, 'success');
      }, 2000);
    }

    /**
     * Imprime o relat√≥rio atual
     */
    function imprimirRelatorio() {
      const conteudo = document.getElementById('relatorio-conteudo').innerHTML;
      const janela = window.open('', '_blank');
      
      janela.document.write(`
        <html>
          <head>
            <title>Relat√≥rio - Instituto Recriar</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .relatorio-header { margin-bottom: 20px; }
            </style>
          </head>
          <body>
            ${conteudo}
          </body>
        </html>
      `);
      
      janela.document.close();
      janela.print();
    }

    /**
     * Fecha o preview do relat√≥rio
     */
    function fecharPreview() {
      document.getElementById('relatorio-preview').style.display = 'none';
    }

    /**
     * Limpa todos os filtros aplicados
     */
    function limparFiltros() {
      document.getElementById('periodo-inicio').value = '';
      document.getElementById('periodo-fim').value = '';
      document.getElementById('turma-filtro').value = '';
      document.getElementById('professor-filtro').value = '';
      
      UI.showMessage('Filtros limpos.', 'info');
    }

    /**
     * Aplica os filtros selecionados
     */
    function aplicarFiltros() {
      const filtros = coletarFiltros();
      const filtrosAtivos = Object.values(filtros).filter(f => f !== null && f !== '').length;
      
      if (filtrosAtivos > 0) {
        UI.showMessage(`${filtrosAtivos} filtro(s) aplicado(s). Gere um relat√≥rio para ver os resultados.`, 'success');
      } else {
        UI.showMessage('Nenhum filtro selecionado.', 'warning');
      }
    }

  </script>
</body>
</html>
