<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o - Sistema de Gest√£o Escolar</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js" defer></script>
</head>
<body>
    <!-- Container que ser√° preenchido pelo JS -->
    <div id="menu-container"></div>

    <main>
        <div class="container">
            <h2>Administra√ß√£o do Sistema</h2>

            <!-- Mensagem de feedback -->
            <div id="feedback-message" class="feedback-message" style="display: none;"></div>

            <!-- Barra de op√ß√µes de CRUD -->
            <div class="crud-bar">
                <!-- Campo de busca -->
                <input type="search" 
                       id="buscar-usuario" 
                       placeholder="Buscar por nome, email ou perfil..." 
                       aria-label="Buscar usu√°rios">

                <!-- Bot√µes de a√ß√£o -->
                <button type="button" 
                        id="btn-incluir" 
                        class="btn-success" 
                        onclick="incluirUsuario()">
                    Novo Usu√°rio
                </button>
                <button type="button" 
                        id="btn-alterar" 
                        onclick="alterarUsuario()" 
                        disabled>
                    Editar
                </button>
                <button type="button" 
                        id="btn-excluir" 
                        class="btn-danger" 
                        onclick="excluirUsuario()" 
                        disabled>
                    Excluir
                </button>
            </div>

            <!-- Estat√≠sticas -->
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-number" id="total-usuarios-count">0</span>
                    <span class="stat-label">Total de Usu√°rios</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="usuarios-ativos-count">0</span>
                    <span class="stat-label">Usu√°rios Ativos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="usuarios-filtrados-count">0</span>
                    <span class="stat-label">Resultados da Busca</span>
                </div>
            </div>

            <!-- Tabela de usu√°rios -->
            <div class="table-container">
                <table class="table" id="tabela-usuarios">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" 
                                       id="select-all" 
                                       aria-label="Selecionar todos os usu√°rios">
                            </th>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Perfil</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-usuarios">
                        <!-- BACKEND: Dados ser√£o carregados via JavaScript a partir de uma API -->
                    </tbody>
                </table>
                
                <!-- Mensagem quando n√£o h√° dados -->
                <div id="no-data-message" class="no-data-message" style="display: none;">
                    <p>Nenhum usu√°rio encontrado.</p>
                    <button type="button" onclick="incluirUsuario()" class="btn-success">
                        Cadastrar Primeiro Usu√°rio
                    </button>
                </div>
            </div>

            <!-- Pagina√ß√£o -->
            <div class="pagination" id="pagination-container" style="display: none;">
                <button type="button" id="btn-prev" onclick="previousPage()" disabled>
                    Anterior
                </button>
                <span id="page-info">P√°gina 1 de 1</span>
                <button type="button" id="btn-next" onclick="nextPage()" disabled>
                    Pr√≥xima
                </button>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script src="menu.js"></script>
    <script>
        // ================================
        // DADOS MOCK DOS USU√ÅRIOS (BACKEND: Substituir por chamada √† API)
        // ================================
        let usuarios = [
            { 
                id: "U001", 
                nome: "Admin Master", 
                email: "admin@teste.com", 
                perfil: "Administrador",
                status: "Ativo",
                dataCriacao: "2024-01-01"
            },
            { 
                id: "U002", 
                nome: "Jo√£o Souza", 
                email: "joao@teste.com", 
                perfil: "Usu√°rio",
                status: "Ativo",
                dataCriacao: "2024-02-15"
            },
            { 
                id: "U003", 
                nome: "Maria Silva", 
                email: "maria@teste.com", 
                perfil: "Usu√°rio",
                status: "Ativo",
                dataCriacao: "2024-03-10"
            },
            { 
                id: "U004", 
                nome: "Carlos Oliveira", 
                email: "carlos@teste.com", 
                perfil: "Gestor",
                status: "Inativo",
                dataCriacao: "2024-04-05"
            }
        ];

        // Vari√°veis de controle
        let usuariosFiltrados = [...usuarios];
        let currentPage = 1;
        const itemsPerPage = CONFIG.ITEMS_PER_PAGE; // BACKEND: CONFIG.ITEMS_PER_PAGE pode ser um valor padr√£o ou vir do backend
        let selectedUsuarios = new Set();

        // ================================
        // INICIALIZA√á√ÉO
        // ================================
        document.addEventListener("DOMContentLoaded", function() {
            // BACKEND: Verificar autentica√ß√£o
            if (!Auth.requireAuth()) return; // Auth.requireAuth() deve ser adaptado para o sistema de autentica√ß√£o do backend

            // Configurar eventos
            setupEventListeners();
            
            // Carregar dados
            // BACKEND: loadUsuarios() deve chamar a API para buscar os usu√°rios
            loadUsuarios();
            
            // Atualizar estat√≠sticas
            // BACKEND: updateStats() pode precisar de dados do backend
            updateStats();
        });

        // ================================
        // CONFIGURAR EVENT LISTENERS
        // ================================
        function setupEventListeners() {
            // Busca em tempo real
            const searchInput = document.getElementById("buscar-usuario");
            searchInput.addEventListener("input", debounce(filtrarUsuarios, 300));

            // Selecionar todos
            const selectAllCheckbox = document.getElementById("select-all");
            selectAllCheckbox.addEventListener("change", toggleSelectAll);

            // Teclas de atalho
            document.addEventListener("keydown", handleKeyboardShortcuts);
        }

        // ================================
        // CARREGAR USU√ÅRIOS NA TABELA
        // ================================
        async function loadUsuarios() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const tbody = document.getElementById("tbody-usuarios");
            const noDataMessage = document.getElementById("no-data-message");
            
            // Limpar tabela
            Table.clearBody("tabela-usuarios");

            // BACKEND: Chamar API para buscar usu√°rios
            // try {
            //   const response = await fetch(`/api/usuarios?page=${currentPage}&limit=${itemsPerPage}&search=${document.getElementById("buscar-usuario").value}`);
            //   if (!response.ok) throw new Error("Erro ao carregar usu√°rios");
            //   const data = await response.json(); // data.usuarios, data.totalUsuarios, etc.
            //   usuarios = data.usuarios; // Atualizar a lista de usu√°rios com os dados do backend
            //   usuariosFiltrados = data.usuarios; // Se a API j√° retorna filtrado/paginado
            // } catch (error) {
            //   console.error("Erro ao buscar usu√°rios:", error);
            //   UI.showMessage("N√£o foi poss√≠vel carregar os usu√°rios.", "error");
            //   return;
            // }
            
            if (usuariosFiltrados.length === 0) {
                document.querySelector(".table-container table").style.display = "none";
                noDataMessage.style.display = "block";
                document.getElementById("pagination-container").style.display = "none";
                return;
            }

            document.querySelector(".table-container table").style.display = "table";
            noDataMessage.style.display = "none";

            // Calcular pagina√ß√£o (se a API n√£o fizer isso, ou para dados mock)
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const usuariosPage = usuariosFiltrados.slice(startIndex, endIndex);

            // Criar linhas
            usuariosPage.forEach(usuario => {
                const row = createUsuarioRow(usuario);
                Table.addRow("tabela-usuarios", row);
            });

            // Atualizar pagina√ß√£o
            updatePagination();
            
            // Atualizar bot√µes
            updateActionButtons();
        }

        // ================================
        // CRIAR LINHA DA TABELA
        // ================================
        function createUsuarioRow(usuario) {
            const row = document.createElement("tr");
            row.dataset.usuarioId = usuario.id;
            
            const isSelected = selectedUsuarios.has(usuario.id);
            const statusClass = usuario.status === "Ativo" ? "status-active" : "status-inactive";
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" 
                           class="usuario-checkbox" 
                           value="${usuario.id}" 
                           ${isSelected ? "checked" : ""}
                           onchange="toggleUsuarioSelection(\'${usuario.id}\')">
                </td>
                <td>${usuario.id}</td>
                <td>${usuario.nome}</td>
                <td>${usuario.email}</td>
                <td>${usuario.perfil}</td>
                <td><span class="status-badge ${statusClass}">${usuario.status}</span></td>
                <td class="actions">
                    <button type="button" 
                            class="btn-sm" 
                            onclick="editarUsuario(\'${usuario.id}\')" 
                            title="Editar usu√°rio">
                        ‚úèÔ∏è
                    </button>
                    <button type="button" 
                            class="btn-sm btn-danger" 
                            onclick="confirmarExclusao(\'${usuario.id}\')" 
                            title="Excluir usu√°rio">
                        üóëÔ∏è
                    </button>
                </td>
            `;
            
            return row;
        }

        // ================================
        // FILTRAR USU√ÅRIOS
        // ================================
        async function filtrarUsuarios() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const searchTerm = document.getElementById("buscar-usuario").value.toLowerCase();
            
            // BACKEND: Se a filtragem for feita no backend, chamar a API com o searchTerm
            // try {
            //   const response = await fetch(`/api/usuarios?search=${searchTerm}`);
            //   if (!response.ok) throw new Error("Erro ao filtrar usu√°rios");
            //   usuariosFiltrados = await response.json();
            // } catch (error) {
            //   console.error("Erro ao filtrar usu√°rios:", error);
            //   UI.showMessage("N√£o foi poss√≠vel filtrar os usu√°rios.", "error");
            //   return;
            // }

            if (!searchTerm) {
                usuariosFiltrados = [...usuarios]; // Usar a lista original se n√£o houver termo de busca
            } else {
                usuariosFiltrados = usuarios.filter(usuario => 
                    usuario.nome.toLowerCase().includes(searchTerm) ||
                    usuario.email.toLowerCase().includes(searchTerm) ||
                    usuario.perfil.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            selectedUsuarios.clear();
            loadUsuarios();
            updateStats();
        }

        // ================================
        // SELE√á√ÉO DE USU√ÅRIOS
        // ================================
        function toggleUsuarioSelection(usuarioId) {
            if (selectedUsuarios.has(usuarioId)) {
                selectedUsuarios.delete(usuarioId);
            } else {
                selectedUsuarios.add(usuarioId);
            }
            
            updateActionButtons();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".usuario-checkbox");
            
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedUsuarios.add(checkbox.value);
                });
            } else {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedUsuarios.delete(checkbox.value);
                });
            }
            
            updateActionButtons();
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".usuario-checkbox");
            const checkedBoxes = document.querySelectorAll(".usuario-checkbox:checked");
            
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        // ================================
        // ATUALIZAR BOT√ïES DE A√á√ÉO
        // ================================
        function updateActionButtons() {
            const hasSelection = selectedUsuarios.size > 0;
            const singleSelection = selectedUsuarios.size === 1;
            
            document.getElementById("btn-alterar").disabled = !singleSelection;
            document.getElementById("btn-excluir").disabled = !hasSelection;
        }

        // ================================
        // FUN√á√ïES DE CRUD
        // ================================
        function incluirUsuario() {
            window.location.href = "novo-usuario.html"; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        function alterarUsuario() {
            if (selectedUsuarios.size !== 1) {
                UI.showMessage("Selecione exatamente um usu√°rio para editar.", "warning");
                return;
            }
            
            const usuarioId = Array.from(selectedUsuarios)[0];
            window.location.href = `alterar-usuario.html?id=${usuarioId}`; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        function editarUsuario(usuarioId) {
            window.location.href = `alterar-usuario.html?id=${usuarioId}`; // BACKEND: Pode ser um redirecionamento para uma rota do backend
        }

        async function excluirUsuario() { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            if (selectedUsuarios.size === 0) {
                UI.showMessage("Selecione pelo menos um usu√°rio para excluir.", "warning");
                return;
            }
            
            const count = selectedUsuarios.size;
            const message = count === 1 
                ? "Tem certeza que deseja excluir este usu√°rio?" 
                : `Tem certeza que deseja excluir ${count} usu√°rios?`;
            
            if (confirm(message)) {
                // BACKEND: Chamar API para exclus√£o de usu√°rios
                // try {
                //   const response = await fetch("/api/usuarios/batch-delete", {
                //     method: "DELETE",
                //     headers: { "Content-Type": "application/json" },
                //     body: JSON.stringify({ ids: Array.from(selectedUsuarios) })
                //   });
                //   if (!response.ok) throw new Error("Erro ao excluir usu√°rios");
                //   // L√≥gica para remover do array local se necess√°rio, ou recarregar
                // } catch (error) {
                //   console.error("Erro ao excluir usu√°rios:", error);
                //   UI.showMessage("N√£o foi poss√≠vel excluir os usu√°rios.", "error");
                //   return;
                // }

                // Simular exclus√£o (integrar com backend)
                selectedUsuarios.forEach(usuarioId => {
                    const index = usuarios.findIndex(u => u.id === usuarioId);
                    if (index > -1) {
                        usuarios.splice(index, 1);
                    }
                });
                
                selectedUsuarios.clear();
                filtrarUsuarios(); // Recarregar dados ap√≥s exclus√£o
                UI.showMessage(`${count} usu√°rio(s) exclu√≠do(s) com sucesso.`, "success");
            }
        }

        async function confirmarExclusao(usuarioId) { // BACKEND: Tornar ass√≠ncrona para chamadas de API
            const usuario = usuarios.find(u => u.id === usuarioId);
            if (!usuario) return;
            
            if (confirm(`Tem certeza que deseja excluir o usu√°rio \"${usuario.nome}\"?`)) {
                // BACKEND: Chamar API para exclus√£o de um √∫nico usu√°rio
                // try {
                //   const response = await fetch(`/api/usuarios/${usuarioId}`, {
                //     method: "DELETE"
                //   });
                //   if (!response.ok) throw new Error("Erro ao excluir usu√°rio");
                // } catch (error) {
                //   console.error("Erro ao excluir usu√°rio:", error);
                //   UI.showMessage("N√£o foi poss√≠vel excluir o usu√°rio.", "error");
                //   return;
                // }

                const index = usuarios.findIndex(u => u.id === usuarioId);
                if (index > -1) {
                    usuarios.splice(index, 1);
                    filtrarUsuarios(); // Recarregar dados ap√≥s exclus√£o
                    UI.showMessage("Usu√°rio exclu√≠do com sucesso.", "success");
                }
            }
        }

        // ================================
        // PAGINA√á√ÉO
        // ================================
        function updatePagination() {
            const totalPages = Math.ceil(usuariosFiltrados.length / itemsPerPage);
            const paginationContainer = document.getElementById("pagination-container");
            
            if (totalPages <= 1) {
                paginationContainer.style.display = "none";
                return;
            }
            
            paginationContainer.style.display = "flex";
            
            document.getElementById("btn-prev").disabled = currentPage === 1;
            document.getElementById("btn-next").disabled = currentPage === totalPages;
            document.getElementById("page-info").textContent = `P√°gina ${currentPage} de ${totalPages}`;
        }

        function nextPage() {
            const totalPages = Math.ceil(usuariosFiltrados.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                loadUsuarios();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadUsuarios();
            }
        }

        // ================================
        // ATUALIZAR ESTAT√çSTICAS
        // ================================
        function updateStats() {
            document.getElementById("total-usuarios-count").textContent = usuarios.length; // BACKEND: Total de usu√°rios do backend
            document.getElementById("usuarios-ativos-count").textContent = usuarios.filter(u => u.status === "Ativo").length; // BACKEND: Contagem de ativos do backend
            document.getElementById("usuarios-filtrados-count").textContent = usuariosFiltrados.length;
        }

        // ================================
        // UTILS (do common.js, se n√£o estiver globalmente dispon√≠vel)
        // ================================
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
    </script>
</body>
</html>

